# .github/workflows/pake-build.yml
name: Build Pake App

on:
  repository_dispatch:
    types: [build-pake-app]

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev webkit2gtk-4.0 libayatana-appindicator3-dev librsvg2-dev

      - name: Clone Pake Repository
        run: |
          git clone --depth 1 https://github.com/tw93/Pake.git
          cd Pake
          npm install
        shell: bash

      - name: Configure Project
        run: |
          cd Pake/src-tauri
          cargo update
          export URL="${{ github.event.client_payload.url }}"
          export NAME="${{ github.event.client_payload.name }}"
          sed -i.bak "s|\"productName\": \".*\"|\"productName\": \"$NAME\"|" tauri.conf.json
          sed -i.bak "s|\"title\": \".*\"|\"title\": \"$NAME\"|" tauri.conf.json
          cat > ../src/defaults.ts << EOF
          export const url = "$URL";
          export const height = 800;
          export const width = 1280;
          EOF
        shell: bash

      - name: Build
        run: |
          cd Pake
          npm run build
        shell: bash

      - name: Package Apps
        run: |
          cd Pake
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp "src-tauri/target/release/${{ github.event.client_payload.name }}.exe" "../${{ github.event.client_payload.name }}-windows.exe"
            cd ..
            Compress-Archive -Path "${{ github.event.client_payload.name }}-windows.exe" -DestinationPath "${{ github.event.client_payload.name }}-windows.zip"
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            cd src-tauri/target/release/bundle/macos
            zip -r "../../../../../${{ github.event.client_payload.name }}-macos.zip" *.app
          else
            cd src-tauri/target/release/bundle/appimage
            zip -r "../../../../../${{ github.event.client_payload.name }}-linux.zip" *.AppImage
          fi
        shell: bash

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.client_payload.name }}-${{ matrix.os }}
          path: ${{ github.event.client_payload.name }}-*.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: ${{ github.event.client_payload.name }}-*.zip
          name: ${{ github.event.client_payload.name }}
          tag_name: release-${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Supabase Status
        run: |
          curl -X PATCH "${{ env.SUPABASE_URL }}/rest/v1/pake_apps" \
          -H "apikey: ${{ env.SUPABASE_ANON_KEY }}" \
          -H "Content-Type: application/json" \
          -d "{\"status\":\"completed\",\"download_url\":\"${{ github.server_url }}/${{ github.repository }}/releases/tag/release-${{ github.sha }}\"}"
